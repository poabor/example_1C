#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ 1CV8Clst.lst
if [ ! -f "1CV8Clst.lst" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª 1CV8Clst.lst –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–∫—Ä–æ–º–µ —Å–∫—Ä—ã—Ç—ã—Ö –∏ ./ ../)
existing_folders=$(find . -maxdepth 1 -type d ! -name '.' ! -name '.*' -printf '%f\n' | sort)

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º–µ–Ω–∞ –ø–∞–ø–æ–∫ –∏–∑ 1CV8Clst.lst (–∏–≥–Ω–æ—Ä–∏—Ä—É—è { –≤ –Ω–∞—á–∞–ª–µ –∏ –≤—Å—ë –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–ø—è—Ç–æ–π)
listed_folders=$(grep -oP '^\{\K[^,]+' 1CV8Clst.lst | sort -u)

# –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∞–ø–∫–∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: 5 –±–ª–æ–∫–æ–≤ —Å "-" –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –Ω–∞ "snccntx"
valid_folders=$(echo "$existing_folders" | grep -P '^[^-]+-[^-]+-[^-]+-[^-]+-[^-]+$' | grep -v '^snccntx')

# –ù–∞—Ö–æ–¥–∏–º –ø–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ 1CV8Clst.lst
missing_folders=$(comm -23 <(echo "$valid_folders") <(echo "$listed_folders"))

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–∑–º–µ—Ä–∞—Ö –ø–∞–ø–æ–∫
temp_file=$(mktemp)

# –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞–∑–º–µ—Ä–∞—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–∞–ø–æ–∫
total_size=0
for folder in $missing_folders; do
    if [ -d "$folder" ]; then
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ –≤ –±–∞–π—Ç–∞—Ö
        size_bytes=$(du -sb "$folder" | cut -f1)
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —É–¥–æ–±–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
        size_human=$(du -sh "$folder" | cut -f1)
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (—Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö + –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞)
        echo "$size_bytes $size_human $folder" >> "$temp_file"
        # –°—É–º–º–∏—Ä—É–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä
        total_size=$((total_size + size_bytes))
    fi
done

if [ -z "$missing_folders" ]; then
    echo "‚úÖ –í—Å–µ –ø–∞–ø–∫–∏ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º) –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ 1CV8Clst.lst."
    rm -f "$temp_file"
    exit 0
fi

echo "üìÇ –ü–∞–ø–∫–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ 1CV8Clst.lst (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–∞–∑–º–µ—Ä—É ‚Üì):"
echo "----------------------------------------"

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä—É (–ø–æ —É–±—ã–≤–∞–Ω–∏—é) –∏ –≤—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
sort -rn "$temp_file" | while read -r size_bytes size_human folder; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä–æ–π –±–ª–æ–∫ –¥–ª—è —ç—Ç–æ–π –ø–∞–ø–∫–∏
    second_block=$(grep -oP "^\{$folder,\s*\"\K[^\"]+" 1CV8Clst.lst | head -1)
    if [ -n "$second_block" ]; then
        echo "‚ûñ $folder (—Ä–∞–∑–º–µ—Ä: $size_human) ‚Üí –≤—Ç–æ—Ä–æ–π –±–ª–æ–∫: \"$second_block\""
    else
        echo "‚ûñ $folder (—Ä–∞–∑–º–µ—Ä: $size_human)"
    fi
done

echo "----------------------------------------"

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤ —É–¥–æ–±–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
if [ $total_size -ge 1073741824 ]; then  # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 1 –ì–ë
    total_size_human=$(awk "BEGIN {printf \"%.2f G–ë\", $total_size/1073741824}")
elif [ $total_size -ge 1048576 ]; then  # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 1 –ú–ë
    total_size_human=$(awk "BEGIN {printf \"%.2f M–ë\", $total_size/1048576}")
elif [ $total_size -ge 1024 ]; then     # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 1 –ö–ë
    total_size_human=$(awk "BEGIN {printf \"%.2f K–ë\", $total_size/1024}")
else
    total_size_human="$total_size –ë"
fi

echo "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–∞–ø–æ–∫: $total_size_human"
echo "üî¢ –í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ: $(echo "$missing_folders" | wc -l) –ø–∞–ø–æ–∫."

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$temp_file"

# read -p "–£–¥–∞–ª–∏—Ç—å —ç—Ç–∏ –ø–∞–ø–∫–∏ –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å $total_size_human? (y/N) " answer
if [[ "$answer" =~ [yY] ]]; then
    echo "–£–¥–∞–ª–µ–Ω–∏–µ..."
    rm -rf $missing_folders
